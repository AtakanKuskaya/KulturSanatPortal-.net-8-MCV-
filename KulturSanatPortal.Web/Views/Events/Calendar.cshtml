@using System.Globalization
@using KulturSanatPortal.Web.Models.Home

@{
    var tr = CultureInfo.GetCultureInfo("tr-TR");

    // --- Model'den güvenli liste çıkar ---
    object? Prop(object? o, string n) { var p = o?.GetType().GetProperty(n); return p?.GetValue(o); }
    IEnumerable<object> AsList(object? o)
    {
        if (o is null) return Enumerable.Empty<object>();
        if (o is IEnumerable<object> ie) return ie;
        if (o is System.Collections.IEnumerable ien && o is not string) return ien.Cast<object>();
        return Enumerable.Empty<object>();
    }

    var items = AsList(Model).ToList();  // Controller: ListForCalendar... döndürüyor

    // --- Ay/Yıl (ViewBag -> bugün) ---
    int y = (ViewBag?.Year as int?) ?? DateTime.Today.Year;
    int m = (ViewBag?.Month as int?) ?? DateTime.Today.Month;

    // --- Takvim için gün/adet haritası (listelenen kayıtlar üzerinden) ---
    var counts = items
        .Select(e => Prop(e, "StartLocal"))
        .OfType<DateTime>()
        .GroupBy(d => d.Date)
        .ToDictionary(g => g.Key, g => g.Count());

    // --- Home'daki MiniCalendarVm ile birebir 6x7 grid (Pazartesi başlangıç) ---
    var first = new DateTime(y, m, 1);
    var offset = ((int)first.DayOfWeek + 6) % 7; // Mon=0..Sun=6
    var start = first.AddDays(-offset);

    var days = new List<MiniDay>(42);
    for (int i = 0; i < 42; i++)
    {
        var d = start.AddDays(i);
        counts.TryGetValue(d.Date, out var c);
        days.Add(new MiniDay(
            d,                 // DateLocal
            d.Month == m,      // InMonth
            d.Date == DateTime.Today.Date, // IsToday
            c                  // Count
        ));
    }
    var cal = new MiniCalendarVm { Year = y, Month = m, Days = days };

    string MonthTitle(int Y, int M) => new DateTime(Y, M, 1).ToString("MMMM yyyy", tr);
}

<div class="container-xxl px-3 px-lg-4 events-page">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card soft shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white border-0 fw-semibold fs-5">@MonthTitle(y, m)</div>
                <div class="card-body">
                    @* Takvim: doğru tipte model *@
                    @await Html.PartialAsync("_MiniCalendar", cal)
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="evt-list">
                @foreach (var e in items)
                {
                    string title = (Prop(e, "Title") ?? Prop(e, "Name"))?.ToString() ?? "Etkinlik";
                    string? slug = (Prop(e, "Slug") ?? Prop(e, "Id"))?.ToString();
                    string? img = (Prop(e, "HeroImagePath") ?? Prop(e, "ImageUrl"))?.ToString();
                    string? venue = (Prop(e, "VenueName") ?? Prop(e, "Venue"))?.ToString();
                    var startDt = (Prop(e, "StartLocal") as DateTime?) ?? DateTime.MinValue;

                    var imgUrl = string.IsNullOrWhiteSpace(img)
                    ? Url.Content("~/img/placeholders/event-wide.jpg")
                    : (img!.StartsWith("/") ? Url.Content(img) : img);

                    <article class="evt-item shadow-sm">
                        <div class="thumb"><img src="@imgUrl" alt="@title" /></div>
                        <div class="content">
                            <h3 class="evt-title">
                                <a class="stretched-link text-decoration-none"
                                   asp-controller="Events" asp-action="Details" asp-route-slug="@slug">@title</a>
                            </h3>
                            @if (!string.IsNullOrWhiteSpace(venue))
                            {
                                <div class="evt-venue"><i class="bi bi-geo-alt"></i> @venue</div>
                            }
                        </div>
                        <div class="meta">
                            <div class="meta-col"><div class="label">Tarih</div><div class="value">@startDt.ToString("dd.MM.yyyy", tr)</div></div>
                            <div class="meta-col"><div class="label">Saat</div><div class="value">@startDt.ToString("HH:mm", tr)</div></div>
                            <div class="more">
                                <a asp-controller="Events" asp-action="Details" asp-route-slug="@slug" class="link-more">
                                    Detaylar <i class="bi bi-chevron-right"></i>
                                </a>
                            </div>
                        </div>
                    </article>
                }
            </div>
        </div>
    </div>
</div>
