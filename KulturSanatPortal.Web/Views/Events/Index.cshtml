@using System.Globalization
@using KulturSanatPortal.Web.Models.Home
@using KulturSanatPortal.Application.Categories

@{
    ViewData["Title"] = "Etkinlikler";
    var tr = CultureInfo.GetCultureInfo("tr-TR");

    object? Prop(object? o, string n) { var p = o?.GetType().GetProperty(n); return p?.GetValue(o); }
    IEnumerable<object> AsList(object? o)
    {
        if (o is null) return Enumerable.Empty<object>();
        if (o is IEnumerable<object> ie) return ie;
        if (o is System.Collections.IEnumerable ien && o is not string) return ien.Cast<object>();
        foreach (var k in new[] { "Items", "Events", "List", "Results", "Data" })
        {
            var v = Prop(o, k);
            if (v is IEnumerable<object> ie2) return ie2;
            if (v is System.Collections.IEnumerable ien2 && v is not string) return ien2.Cast<object>();
        }
        return Enumerable.Empty<object>();
    }

    var items = AsList(Model).ToList(); // sağdaki ilk liste
    var cal = (MiniCalendarVm)ViewBag.CalendarModel;
    var cats = (IEnumerable<CategoryDto>)(ViewBag?.Categories ?? Enumerable.Empty<CategoryDto>());
    string? selectedDate = ViewBag.SelectedDate as string;
    int? selectedCat = ViewBag.SelectedCategory as int?;
}

<div class="container-xxl px-3 px-lg-4 events-page">
    <div class="row g-4">
        <!-- SOL: Takvim + Kategoriler -->
        <aside class="col-lg-4">
            <div class="card soft shadow-sm rounded-4 overflow-hidden mb-3">
                <div class="card-header bg-white border-0 fw-semibold fs-5">Etkinlik Takvimi</div>
                <div class="card-body">
                    @await Html.PartialAsync("_MiniCalendar", cal)
                    <div class="small text-secondary mt-2">
                        <i class="bi bi-dot"></i>o günkü etkinlik sayısı · güne tıklayınca liste açılır.
                    </div>
                </div>
            </div>

            @if (cats.Any())
            {
                <div class="card soft shadow-sm rounded-4 overflow-hidden">
                    <div class="card-header bg-white border-0 fw-semibold fs-6">Kategoriler</div>
                    <div class="card-body">
                        <form id="catForm" class="d-grid gap-2" onsubmit="return false">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="categoryId" id="cat_all" value=""
                                       @(selectedCat is null ? "checked" : null) />
                                <label class="form-check-label" for="cat_all">Tümünü Göster</label>
                            </div>
                            @foreach (var c in cats)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="categoryId" id="cat_@c.Id" value="@c.Id"
                                           @(selectedCat == c.Id ? "checked" : null) />
                                    <label class="form-check-label" for="cat_@c.Id">@c.Name</label>
                                </div>
                            }
                        </form>
                    </div>
                </div>
            }
        </aside>

        <!-- SAĞ: Liste -->
        <div class="col-lg-8">
            <div class="d-flex flex-wrap gap-2 justify-content-end mb-2">
                <a class="btn btn-light btn-sm" href="#" data-today>Bugün</a>
                <a class="btn btn-light btn-sm" asp-controller="Events" asp-action="Index" asp-route-week="this">Bu Hafta</a>
                <a class="btn btn-light btn-sm" asp-controller="Events" asp-action="Index">Tümünü Göster</a>
            </div>

            <div id="evtList">
                @await Html.PartialAsync("_EventList", items)
            </div>
        </div>
    </div>
</div>
