@model KulturSanatPortal.Web.Models.Home.MiniCalendarVm
@using System.Globalization
@{
    var tr = CultureInfo.GetCultureInfo("tr-TR");
    var prev = new DateTime(Model.Year, Model.Month, 1).AddMonths(-1);
    var next = new DateTime(Model.Year, Model.Month, 1).AddMonths(1);
    var names = new[] { "Pzt", "Sal", "Çar", "Per", "Cum", "Cts", "Paz" };
}

<div class="calendar-mini compact">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <a class="btn btn-sm btn-outline-light" asp-controller="Events" asp-action="Index"
           asp-route-y="@prev.Year" asp-route-m="@prev.Month"><i class="bi bi-chevron-left"></i></a>

        <div class="fw-semibold">@(new DateTime(Model.Year, Model.Month, 1).ToString("MMMM yyyy", tr))</div>

        <a class="btn btn-sm btn-outline-light" asp-controller="Events" asp-action="Index"
           asp-route-y="@next.Year" asp-route-m="@next.Month"><i class="bi bi-chevron-right"></i></a>
    </div>

    <table class="table table-dark table-sm table-borderless align-middle text-center mb-0">
        <thead>
            <tr class="small text-secondary">
                @foreach (var h in names)
                {
                    <th class="py-1">@h</th>
                }
            </tr>
        </thead>
        <tbody>
            @for (int r = 0; r < 6; r++)
            {
                <tr>
                    @for (int c = 0; c < 7; c++)
                    {
                        var d = Model.Days[r * 7 + c];
                        var muted = d.InMonth ? "" : "text-secondary-50";
                        var today = d.IsToday ? "today" : "";
                        var iso = d.DateLocal.ToString("yyyy-MM-dd");
                        <td class="@muted p-1">
                            <div class="position-relative day @today">
                                <a href="#" class="stretched-link day-select" data-date="@iso"
                                   aria-label="@d.DateLocal.ToString("dd MMMM yyyy", tr)"></a>
                                <div class="small fw-semibold">@d.DateLocal.Day</div>
                                @if (d.Count > 0)
                                {
                                    <span class="badge text-bg-primary position-absolute end-0 bottom-0 me-1 mb-1">@d.Count</span>
                                }
                            </div>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        // Gün seçimini uygulamaya yayınla
        (function(){
          const root = document.currentScript.closest('.calendar-mini');
          root?.addEventListener('click', function(e){
            const a = e.target.closest('a.day-select');
            if(!a) return;
            e.preventDefault();
            const iso = a.getAttribute('data-date');
            document.dispatchEvent(new CustomEvent('miniCalendar:select', { detail:{ date: iso } }));
          });
        })();
    </script>
}
